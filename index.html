<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoNz Chord Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        :root {
            --brand-primary: #6366f1;
            --bg-main: #09090b;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-main); color: #f4f4f5; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        
        pre {
            font-family: 'JetBrains Mono', monospace;
            white-space: pre; 
            word-wrap: normal;
            margin: 0;
            padding: 0;
        }

        .chord-line { color: #818cf8; font-weight: 700; margin-top: 1.2rem; }
        .lyrics-line { color: #d4d4d8; margin-top: 0.1rem; }
        
        .structure-line { 
            color: #fbbf24; 
            font-weight: 800; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 2rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
            display: inline-block;
        }
        
        .glass-panel {
            background: rgba(24, 24, 27, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(63, 63, 70, 0.4);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .song-container {
            overflow-x: auto;
            width: 100%;
        }

        @media print {
            .glass-panel, button, input, header, .fixed { display: none !important; }
            body { background: white; color: black; }
            .lyrics-line { color: black; }
            .chord-line { color: #444; }
            .structure-line { color: black; border-bottom: 1px solid #ccc; }
            #root > div { display: block !important; }
            pre { font-size: 12pt; white-space: pre-wrap; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({
                        icons: { [name]: window.lucide[name] },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, size]);
            return <i ref={iconRef} data-lucide={name} className={`inline-block ${className}`} style={{ width: size, height: size }}></i>;
        };

        const CHROMATIC = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const FLAT_MAP = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' };

        const App = () => {
            const [songs, setSongs] = useState(() => JSON.parse(localStorage.getItem('ronz_songs') || '[]'));
            const [setlists, setSetlists] = useState(() => JSON.parse(localStorage.getItem('ronz_setlists') || '[]'));
            const [view, setView] = useState('library'); 
            const [activeSong, setActiveSong] = useState(null);
            const [activeSetlist, setActiveSetlist] = useState(null);
            const [activeSetlistIndex, setActiveSetlistIndex] = useState(0);
            const [searchTerm, setSearchTerm] = useState('');
            const [status, setStatus] = useState(null);
            const [setlistForm, setSetlistForm] = useState({ name: '', description: '', songIds: [] });

            const [form, setForm] = useState({ title: '', artist: '', content: '', tempo: 120, key: 'C', style: '', youtube: '' });
            const [transpose, setTranspose] = useState(0);
            const [isScrolling, setIsScrolling] = useState(false);
            const [scrollSpeed, setScrollSpeed] = useState(2);
            const [isMetronomeOn, setIsMetronomeOn] = useState(false);
            const [currentBpm, setCurrentBpm] = useState(120);
            const [beat, setBeat] = useState(0);
            const [showVideo, setShowVideo] = useState(false);

            const scrollRef = useRef(null);
            const scrollPosRef = useRef(0);
            const audioCtx = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('ronz_songs', JSON.stringify(songs));
            }, [songs]);

            useEffect(() => {
                localStorage.setItem('ronz_setlists', JSON.stringify(setlists));
            }, [setlists]);

            const notify = (msg) => {
                setStatus(msg);
                setTimeout(() => setStatus(null), 3000);
            };

            const transposeChord = useCallback((chordLine, steps) => {
                if (steps === 0) return chordLine;
                const chordRegex = /[A-G][#b]?(?:m|maj|min|dim|aug|sus|add|7|9|11|13|sus4|sus2|maj7)?(?:\/[A-G][#b]?)?/gi;
                return chordLine.replace(chordRegex, (chord) => {
                    return chord.replace(/[A-G][#b]?/g, (root) => {
                        let r = FLAT_MAP[root] || root;
                        let idx = CHROMATIC.indexOf(r.toUpperCase());
                        if (idx === -1) return root;
                        let newIdx = (idx + steps) % 12;
                        if (newIdx < 0) newIdx += 12;
                        return CHROMATIC[newIdx];
                    });
                });
            }, []);

            const isChordLine = (line) => {
                const trimmed = line.trim();
                if (!trimmed || trimmed.length > 150) return false;
                const words = trimmed.split(/\s+/).filter(w => w.length > 0);
                if (words.length === 0) return false;
                const chordRegex = /^[A-G][#b]?(?:m|maj|min|dim|aug|sus|add|7|9|11|13|sus4|sus2|maj7)?(?:\/[A-G][#b]?)?$|^\|$/i;
                return words.every(w => chordRegex.test(w) || w === '|' || w === '-' || w === '·' || w === ':' || w === '.');
            };

            const isStructureLine = (line) => {
                const trimmed = line.trim().toLowerCase();
                const structures = ['intro', 'verse', 'chorus', 'reff', 'bridge', 'outro', 'ending', 'coda', 'interlude', 'solo', 'pre-chorus', 'pre-reff'];
                return structures.some(s => trimmed.startsWith(s) || (trimmed.startsWith('[') && trimmed.includes(s)));
            };

            useEffect(() => {
                let timer;
                if (isMetronomeOn) {
                    if (!audioCtx.current) audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                    const interval = 60000 / currentBpm;
                    timer = setInterval(() => {
                        const osc = audioCtx.current.createOscillator();
                        const gain = audioCtx.current.createGain();
                        osc.frequency.setValueAtTime(beat % 4 === 0 ? 1000 : 500, audioCtx.current.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.current.currentTime + 0.1);
                        osc.connect(gain); gain.connect(audioCtx.current.destination);
                        osc.start(); osc.stop(audioCtx.current.currentTime + 0.1);
                        setBeat(b => b + 1);
                    }, interval);
                }
                return () => clearInterval(timer);
            }, [isMetronomeOn, currentBpm, beat]);

            useEffect(() => {
                let animationFrameId;
                const scrollStep = () => {
                    if (isScrolling && scrollRef.current) {
                        const container = scrollRef.current;
                        if (container.scrollTop + container.clientHeight >= container.scrollHeight - 5) {
                            setIsScrolling(false);
                            return;
                        }
                        scrollPosRef.current += (scrollSpeed / 2.5); 
                        container.scrollTop = Math.floor(scrollPosRef.current);
                        animationFrameId = requestAnimationFrame(scrollStep);
                    }
                };
                if (isScrolling) {
                    if (scrollRef.current) scrollPosRef.current = scrollRef.current.scrollTop;
                    animationFrameId = requestAnimationFrame(scrollStep);
                }
                return () => { if (animationFrameId) cancelAnimationFrame(animationFrameId); };
            }, [isScrolling, scrollSpeed]);

            const handleManualScroll = () => {
                if (scrollRef.current) scrollPosRef.current = scrollRef.current.scrollTop;
            };

            const exportData = () => {
                const data = JSON.stringify({ songs, setlists }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ronz_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                notify("Data diekspor!");
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.songs) setSongs(data.songs);
                        if (data.setlists) setSetlists(data.setlists);
                        notify("Data berhasil diimpor!");
                    } catch (err) { notify("Gagal mengimpor file!"); }
                };
                reader.readAsText(file);
            };

            const handleSave = () => {
                if (!form.title || !form.content) return notify("Judul & Isi wajib diisi!");
                const newSong = { ...form, id: form.id || Date.now().toString() };
                if (form.id) {
                    setSongs(songs.map(s => s.id === form.id ? newSong : s));
                } else {
                    setSongs([newSong, ...songs]);
                }
                setView('library');
                notify("Lagu disimpan");
            };

            const openStage = (song) => {
                setActiveSong(song);
                setActiveSetlist(null);
                setActiveSetlistIndex(0);
                setCurrentBpm(song.tempo || 120);
                setTranspose(0);
                setIsScrolling(false);
                setShowVideo(false);
                setView('stage');
                scrollPosRef.current = 0;
            };

            const openSetlistStage = (setlist) => {
                if (!setlist.songIds || setlist.songIds.length === 0) {
                    notify("Setlist kosong!");
                    return;
                }
                const firstSong = songs.find(s => s.id === setlist.songIds[0]);
                if (!firstSong) {
                    notify("Lagu tidak ditemukan!");
                    return;
                }
                setActiveSetlist(setlist);
                setActiveSetlistIndex(0);
                setActiveSong(firstSong);
                setCurrentBpm(firstSong.tempo || 120);
                setTranspose(0);
                setIsScrolling(false);
                setShowVideo(false);
                setView('stage');
                scrollPosRef.current = 0;
            };

            const navigateSetlist = (direction) => {
                if (!activeSetlist) return;
                const newIndex = activeSetlistIndex + direction;
                if (newIndex < 0 || newIndex >= activeSetlist.songIds.length) return;
                const nextSong = songs.find(s => s.id === activeSetlist.songIds[newIndex]);
                if (!nextSong) return;
                setActiveSetlistIndex(newIndex);
                setActiveSong(nextSong);
                setCurrentBpm(nextSong.tempo || 120);
                setTranspose(0);
                setIsScrolling(false);
                if (scrollRef.current) scrollRef.current.scrollTop = 0;
                scrollPosRef.current = 0;
            };

            const getYouTubeId = (url) => {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = url?.match(regExp);
                return (match && match[2].length === 11) ? match[2] : url;
            };

            const handleSetlistSave = () => {
                if (!setlistForm.name) return notify("Nama setlist wajib diisi!");
                const newSetlist = { ...setlistForm, id: setlistForm.id || Date.now().toString() };
                if (setlistForm.id) {
                    setSetlists(setlists.map(sl => sl.id === setlistForm.id ? newSetlist : sl));
                } else {
                    setSetlists([newSetlist, ...setlists]);
                }
                setView('setlists');
                notify("Setlist disimpan");
            };

            const toggleSongInSetlist = (songId) => {
                const songIds = setlistForm.songIds || [];
                if (songIds.includes(songId)) {
                    setSetlistForm({...setlistForm, songIds: songIds.filter(id => id !== songId)});
                } else {
                    setSetlistForm({...setlistForm, songIds: [...songIds, songId]});
                }
            };

            const removeSongFromSetlist = (songId) => {
                const songIds = setlistForm.songIds || [];
                setSetlistForm({...setlistForm, songIds: songIds.filter(id => id !== songId)});
            };

            const moveSongInSetlist = (index, direction) => {
                const newSongIds = [...setlistForm.songIds];
                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= newSongIds.length) return;
                [newSongIds[index], newSongIds[newIndex]] = [newSongIds[newIndex], newSongIds[index]];
                setSetlistForm({...setlistForm, songIds: newSongIds});
            };

            const filteredSongs = useMemo(() => {
                return songs.filter(s => 
                    s.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    s.artist.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [songs, searchTerm]);

            return (
                <div className="flex flex-col min-h-screen">
                    <input type="file" ref={fileInputRef} className="hidden" onChange={importData} accept=".json" />
                    
                    {status && (
                        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[2000] bg-white text-black px-6 py-3 rounded-full font-bold shadow-2xl flex items-center gap-2 animate-in fade-in slide-in-from-bottom-4">
                            <Icon name="CheckCircle" className="text-indigo-600" /> {status}
                        </div>
                    )}

                    {view !== 'stage' && (
                        <header className="sticky top-0 z-50 glass-panel border-b border-zinc-800 p-4">
                            <div className="max-w-6xl mx-auto flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/30">
                                        <Icon name="Zap" className="text-white" />
                                    </div>
                                    <div className="leading-tight">
                                        <h1 className="font-black text-xl tracking-tighter uppercase hidden sm:block">RoNz</h1>
                                        <p className="text-[10px] font-bold text-zinc-500 tracking-[0.2em] hidden sm:block uppercase">CHORD PRO</p>
                                    </div>
                                </div>
                                <div className="flex gap-1.5 sm:gap-2">
                                    <button onClick={() => setView('setlists')} className={`p-2.5 rounded-xl transition-all ${view === 'setlists' ? 'bg-indigo-600 text-white' : 'bg-zinc-800 text-zinc-400 hover:text-white'}`}><Icon name="ListMusic" size={18}/></button>
                                    <button onClick={() => fileInputRef.current.click()} className="p-2.5 bg-zinc-800 text-zinc-400 rounded-xl hover:text-white"><Icon name="Upload" size={18}/></button>
                                    <button onClick={exportData} className="p-2.5 bg-zinc-800 text-zinc-400 rounded-xl hover:text-white"><Icon name="Download" size={18}/></button>
                                    <div className="w-[1px] h-10 bg-zinc-800 mx-1"></div>
                                    <button onClick={() => { setForm({ title: '', artist: '', content: '', tempo: 120, key: 'C', style: '', youtube: '' }); setView('editor'); }} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-black uppercase hover:bg-indigo-500 transition-all">Baru</button>
                                </div>
                            </div>
                        </header>
                    )}

                    {view === 'library' && (
                        <main className="max-w-6xl mx-auto w-full p-6 space-y-8 animate-in fade-in duration-500">
                            <div className="relative group">
                                <Icon name="Search" className="absolute left-5 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-white transition-colors" />
                                <input 
                                    type="text" 
                                    placeholder="Cari lagu atau artis..." 
                                    className="w-full bg-zinc-900 border border-zinc-800 rounded-2xl py-5 pl-14 pr-6 outline-none focus:border-indigo-500 transition-all font-semibold text-lg"
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredSongs.map(song => (
                                    <div key={song.id} className="group bg-zinc-900/40 border border-zinc-800/50 p-6 rounded-[2rem] hover:border-indigo-500 transition-all cursor-pointer relative overflow-hidden" onClick={() => openStage(song)}>
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="max-w-[80%]">
                                                <h3 className="font-extrabold text-xl uppercase leading-tight truncate group-hover:text-indigo-400 transition-colors">{song.title}</h3>
                                                <p className="text-sm text-zinc-500 font-medium truncate">{song.artist}</p>
                                            </div>
                                            <div className="text-indigo-500 font-black text-lg">{song.key}</div>
                                        </div>
                                        <div className="flex gap-2">
                                            <span className="bg-zinc-800/80 text-[10px] font-bold px-3 py-1 rounded-full text-zinc-400">{song.style || 'Song'}</span>
                                            <span className="bg-zinc-800/80 text-[10px] font-bold px-3 py-1 rounded-full text-zinc-400">{song.tempo} BPM</span>
                                        </div>
                                        <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                            <button onClick={(e) => { e.stopPropagation(); setForm(song); setView('editor'); }} className="p-2 bg-zinc-800 rounded-lg text-zinc-400 hover:text-white"><Icon name="Edit" size={16} /></button>
                                            <button onClick={(e) => { e.stopPropagation(); if(confirm('Hapus lagu ini?')) setSongs(songs.filter(s => s.id !== song.id)); }} className="p-2 bg-zinc-800 rounded-lg text-zinc-400 hover:text-red-500"><Icon name="Trash2" size={16} /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </main>
                    )}

                    {view === 'setlists' && (
                        <main className="max-w-6xl mx-auto w-full p-6 space-y-8 animate-in fade-in duration-500">
                            <div className="flex justify-between items-center">
                                <h2 className="text-3xl font-black uppercase">Setlist Saya</h2>
                                <button onClick={() => { setSetlistForm({ name: '', description: '', songIds: [] }); setView('setlist-editor'); }} className="bg-indigo-600 text-white px-6 py-3 rounded-xl text-xs font-black uppercase hover:bg-indigo-500 transition-all flex items-center gap-2">
                                    <Icon name="Plus" size={18} /> Buat Setlist
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {setlists.map(setlist => {
                                    const setlistSongs = (setlist.songIds || []).map(id => songs.find(s => s.id === id)).filter(Boolean);
                                    return (
                                        <div key={setlist.id} className="group bg-zinc-900/40 border border-zinc-800/50 p-6 rounded-[2rem] hover:border-indigo-500 transition-all relative overflow-hidden">
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="max-w-[80%]">
                                                    <h3 className="font-extrabold text-2xl uppercase leading-tight truncate group-hover:text-indigo-400 transition-colors">{setlist.name}</h3>
                                                    <p className="text-sm text-zinc-500 font-medium mt-1">{setlist.description || 'Tidak ada deskripsi'}</p>
                                                    <p className="text-xs text-zinc-600 font-bold mt-2">{setlistSongs.length} Lagu</p>
                                                </div>
                                            </div>
                                            <div className="space-y-2 mb-4">
                                                {setlistSongs.slice(0, 3).map((song, idx) => (
                                                    <div key={song.id} className="text-sm text-zinc-400 flex items-center gap-2">
                                                        <span className="text-zinc-600 font-black">{idx + 1}.</span>
                                                        <span className="truncate">{song.title}</span>
                                                    </div>
                                                ))}
                                                {setlistSongs.length > 3 && (
                                                    <div className="text-xs text-zinc-600 font-bold">+{setlistSongs.length - 3} lagu lainnya</div>
                                                )}
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => openSetlistStage(setlist)} className="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-xl text-xs font-black uppercase hover:bg-indigo-500 transition-all flex items-center justify-center gap-2">
                                                    <Icon name="Play" size={14} /> Mulai
                                                </button>
                                                <button onClick={() => { setSetlistForm(setlist); setView('setlist-editor'); }} className="p-2 bg-zinc-800 rounded-xl text-zinc-400 hover:text-white"><Icon name="Edit" size={16} /></button>
                                                <button onClick={() => { if(confirm('Hapus setlist ini?')) setSetlists(setlists.filter(sl => sl.id !== setlist.id)); }} className="p-2 bg-zinc-800 rounded-xl text-zinc-400 hover:text-red-500"><Icon name="Trash2" size={16} /></button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </main>
                    )}

                    {view === 'setlist-editor' && (
                        <main className="max-w-4xl mx-auto w-full p-6 animate-in slide-in-from-bottom-8 duration-500 pb-20">
                            <div className="glass-panel p-8 rounded-[3rem] border-zinc-800 shadow-2xl space-y-6">
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black uppercase text-zinc-500 ml-2">Nama Setlist</label>
                                    <input className="w-full bg-zinc-800/50 border border-zinc-700/50 p-4 rounded-2xl outline-none focus:border-indigo-500 font-bold" value={setlistForm.name} onChange={e => setSetlistForm({...setlistForm, name: e.target.value})} placeholder="Misal: Ibadah Minggu, Practice Session, dll" />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black uppercase text-zinc-500 ml-2">Deskripsi (Opsional)</label>
                                    <input className="w-full bg-zinc-800/50 border border-zinc-700/50 p-4 rounded-2xl outline-none focus:border-indigo-500 font-bold" value={setlistForm.description} onChange={e => setSetlistForm({...setlistForm, description: e.target.value})} placeholder="Deskripsi setlist" />
                                </div>
                                <div className="space-y-4">
                                    <label className="text-[10px] font-black uppercase text-zinc-500 ml-2">Lagu dalam Setlist</label>
                                    <div className="space-y-3">
                                        {(setlistForm.songIds || []).map((songId, idx) => {
                                            const song = songs.find(s => s.id === songId);
                                            if (!song) return null;
                                            return (
                                                <div key={songId} className="flex items-center gap-3 bg-zinc-800/30 p-4 rounded-2xl border border-zinc-700/50">
                                                    <span className="text-zinc-500 font-black text-lg w-8">{idx + 1}.</span>
                                                    <div className="flex-1">
                                                        <div className="font-bold">{song.title}</div>
                                                        <div className="text-xs text-zinc-500">{song.artist}</div>
                                                    </div>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => moveSongInSetlist(idx, -1)} disabled={idx === 0} className="p-2 bg-zinc-800 rounded-lg text-zinc-400 hover:text-white disabled:opacity-30"><Icon name="ChevronUp" size={16} /></button>
                                                        <button onClick={() => moveSongInSetlist(idx, 1)} disabled={idx === setlistForm.songIds.length - 1} className="p-2 bg-zinc-800 rounded-lg text-zinc-400 hover:text-white disabled:opacity-30"><Icon name="ChevronDown" size={16} /></button>
                                                        <button onClick={() => removeSongFromSetlist(songId)} className="p-2 bg-zinc-800 rounded-lg text-zinc-400 hover:text-red-500"><Icon name="Trash2" size={16} /></button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {(!setlistForm.songIds || setlistForm.songIds.length === 0) && (
                                            <div className="text-center text-zinc-500 py-8">Belum ada lagu. Pilih lagu di bawah.</div>
                                        )}
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <label className="text-[10px] font-black uppercase text-zinc-500 ml-2">Tambah Lagu</label>
                                    <div className="max-h-[400px] overflow-y-auto space-y-2 border border-zinc-800 rounded-2xl p-4">
                                        {songs.map(song => {
                                            const isSelected = (setlistForm.songIds || []).includes(song.id);
                                            return (
                                                <div key={song.id} onClick={() => toggleSongInSetlist(song.id)} className={`flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all ${isSelected ? 'bg-indigo-600/20 border border-indigo-500' : 'bg-zinc-800/30 hover:bg-zinc-800/50'}`}>
                                                    <div className={`w-5 h-5 rounded-md border-2 flex items-center justify-center ${isSelected ? 'bg-indigo-600 border-indigo-600' : 'border-zinc-600'}`}>
                                                        {isSelected && <Icon name="Check" size={14} className="text-white" />}
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="font-bold text-sm">{song.title}</div>
                                                        <div className="text-xs text-zinc-500">{song.artist}</div>
                                                    </div>
                                                    <div className="text-xs text-zinc-600 font-bold">{song.key}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div className="flex gap-4 pt-4">
                                    <button onClick={() => setView('setlists')} className="flex-1 bg-zinc-800 py-5 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-zinc-700">Batal</button>
                                    <button onClick={handleSetlistSave} className="flex-1 bg-indigo-600 py-5 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-indigo-500 shadow-xl shadow-indigo-600/30">Simpan</button>
                                </div>
                            </div>
                        </main>
                    )}

                    {view === 'editor' && (
                        <main className="max-w-4xl mx-auto w-full p-6 animate-in slide-in-from-bottom-8 duration-500 pb-20">
                            <div className="glass-panel p-8 rounded-[3rem] border-zinc-800 shadow-2xl space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black uppercase text-zinc-500 ml-2">Judul</label>
                                        <input className="w-full bg-zinc-800/50 border border-zinc-700/50 p-4 rounded-2xl outline-none focus:border-indigo-500 font-bold" value={form.title} onChange={e => setForm({...form, title: e.target.value})} />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black uppercase text-zinc-500 ml-2">Artis</label>
                                        <input className="w-full bg-zinc-800/50 border border-zinc-700/50 p-4 rounded-2xl outline-none focus:border-indigo-500 font-bold" value={form.artist} onChange={e => setForm({...form, artist: e.target.value})} />
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black uppercase text-zinc-500 ml-2">Key</label>
                                        <input className="w-full bg-zinc-800/50 border border-zinc-700/50 p-4 rounded-2xl outline-none focus:border-indigo-500 font-bold" value={form.key} onChange={e => setForm({...form, key: e.target.value})} placeholder="C" />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black uppercase text-zinc-500 ml-2">Tempo (BPM)</label>
                                        <input type="number" className="w-full bg-zinc-800/50 border border-zinc-700/50 p-4 rounded-2xl outline-none focus:border-indigo-500 font-bold" value={form.tempo} onChange={e => setForm({...form, tempo: parseInt(e.target.value)})} />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black uppercase text-zinc-500 ml-2">YouTube URL/ID</label>
                                        <input className="w-full bg-zinc-800/50 border border-zinc-700/50 p-4 rounded-2xl outline-none focus:border-indigo-500 font-bold text-indigo-400" value={form.youtube} onChange={e => setForm({...form, youtube: e.target.value})} placeholder="ID atau Link Video" />
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black uppercase text-zinc-500 ml-2">Lirik & Chord (Tanpa Wrap)</label>
                                    <textarea 
                                        className="w-full bg-zinc-800/50 border border-zinc-700/50 p-6 rounded-3xl outline-none focus:border-indigo-500 transition-all font-mono text-sm leading-relaxed min-h-[400px] overflow-x-auto whitespace-pre"
                                        style={{ wordWrap: 'normal', whiteSpace: 'pre' }}
                                        value={form.content}
                                        onChange={e => setForm({...form, content: e.target.value})}
                                        placeholder="Posisikan chord di atas lirik dengan spasi."
                                    ></textarea>
                                </div>
                                <div className="flex gap-4 pt-4">
                                    <button onClick={() => setView('library')} className="flex-1 bg-zinc-800 py-5 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-zinc-700">Batal</button>
                                    <button onClick={handleSave} className="flex-1 bg-indigo-600 py-5 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-indigo-500 shadow-xl shadow-indigo-600/30">Simpan</button>
                                </div>
                            </div>
                        </main>
                    )}

                    {view === 'stage' && activeSong && (
                        <div className="fixed inset-0 bg-black z-[100] flex flex-col animate-in fade-in duration-300">
                            <div className="glass-panel border-b border-zinc-900 p-4 px-6 flex justify-between items-center shrink-0">
                                <div className="flex items-center gap-4 max-w-[50%]">
                                    <button onClick={() => setView(activeSetlist ? 'setlists' : 'library')} className="w-10 h-10 bg-zinc-900 rounded-full flex items-center justify-center hover:bg-zinc-800 transition-colors shrink-0"><Icon name="ArrowLeft" /></button>
                                    <div className="truncate">
                                        <h2 className="font-black text-xl uppercase tracking-tighter leading-none truncate">{activeSong.title}</h2>
                                        <p className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">{activeSong.artist}</p>
                                        {activeSetlist && (
                                            <p className="text-[9px] font-bold text-indigo-500 uppercase tracking-widest mt-1">
                                                {activeSetlist.name} • {activeSetlistIndex + 1}/{activeSetlist.songIds.length}
                                            </p>
                                        )}
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    {activeSetlist && (
                                        <>
                                            <button onClick={() => navigateSetlist(-1)} disabled={activeSetlistIndex === 0} className="p-2.5 rounded-xl bg-zinc-900 text-zinc-500 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed">
                                                <Icon name="SkipBack" size={18} />
                                            </button>
                                            <button onClick={() => navigateSetlist(1)} disabled={activeSetlistIndex === activeSetlist.songIds.length - 1} className="p-2.5 rounded-xl bg-zinc-900 text-zinc-500 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed">
                                                <Icon name="SkipForward" size={18} />
                                            </button>
                                            <div className="w-[1px] h-6 bg-zinc-800"></div>
                                        </>
                                    )}
                                    <div className="hidden md:flex items-center gap-2 bg-zinc-900 px-3 py-2 rounded-xl">
                                        <Icon name="ChevronDown" size={14} className="text-zinc-600" />
                                        <input type="range" min="0.1" max="5" step="0.1" value={scrollSpeed} onChange={e => setScrollSpeed(parseFloat(e.target.value))} className="w-20" />
                                    </div>
                                    <button onClick={() => setIsScrolling(!isScrolling)} className={`p-2.5 rounded-xl transition-all ${isScrolling ? 'bg-indigo-600 text-white' : 'bg-zinc-900 text-zinc-500'}`}>
                                        <Icon name={isScrolling ? "Pause" : "Play"} size={18} />
                                    </button>
                                    <button onClick={() => setIsMetronomeOn(!isMetronomeOn)} className={`p-2.5 rounded-xl transition-all ${isMetronomeOn ? 'bg-indigo-600 text-white' : 'bg-zinc-900 text-zinc-500'}`}>
                                        <Icon name="Activity" size={18} />
                                    </button>
                                    {activeSong.youtube && (
                                        <button onClick={() => setShowVideo(!showVideo)} className={`p-2.5 rounded-xl transition-all ${showVideo ? 'bg-red-600 text-white' : 'bg-zinc-900 text-zinc-500'}`}>
                                            <Icon name="Youtube" size={18} />
                                        </button>
                                    )}
                                </div>
                            </div>

                            <div className="flex-1 flex overflow-hidden">
                                <div 
                                    ref={scrollRef} 
                                    onScroll={handleManualScroll}
                                    className="flex-1 overflow-y-auto no-scrollbar"
                                >
                                    <div className="song-container p-8 md:p-16 lg:px-32 pb-60">
                                        <div className="min-w-fit mx-auto text-xl md:text-3xl lg:text-4xl">
                                            {activeSong.content.split('\n').map((line, idx) => {
                                                const chordLine = isChordLine(line);
                                                const structureLine = isStructureLine(line);
                                                
                                                let className = "lyrics-line";
                                                if (chordLine) className = "chord-line";
                                                if (structureLine) className = "structure-line";

                                                return (
                                                    <pre key={idx} className={className}>
                                                        {chordLine ? transposeChord(line, transpose) : (line || ' ')}
                                                    </pre>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                                
                                {showVideo && activeSong.youtube && (
                                    <div className="w-[30%] border-l border-zinc-900 bg-black hidden lg:flex flex-col animate-in slide-in-from-right duration-300">
                                        <div className="aspect-video w-full bg-zinc-900">
                                            <iframe 
                                                width="100%" 
                                                height="100%" 
                                                src={`https://www.youtube.com/embed/${getYouTubeId(activeSong.youtube)}`} 
                                                frameBorder="0" 
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                allowFullScreen
                                            ></iframe>
                                        </div>
                                        <div className="p-4 text-zinc-500 text-xs text-center font-bold uppercase tracking-widest">
                                            Video Referensi
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Floating Controls */}
                            <div className="fixed bottom-6 left-1/2 -translate-x-1/2 glass-panel p-2 px-6 rounded-full z-[110] flex items-center gap-6 shadow-2xl border-zinc-700/50">
                                <div className="flex items-center gap-4">
                                    <span className="text-[9px] font-black uppercase text-zinc-500 hidden sm:inline">Transpose</span>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => setTranspose(t => t - 1)} className="w-8 h-8 bg-zinc-800 rounded-lg flex items-center justify-center hover:bg-zinc-700"><Icon name="Minus" size={14}/></button>
                                        <span className={`w-8 text-center font-black text-lg ${transpose !== 0 ? 'text-indigo-400' : ''}`}>{transpose > 0 ? `+${transpose}` : transpose}</span>
                                        <button onClick={() => setTranspose(t => t + 1)} className="w-8 h-8 bg-zinc-800 rounded-lg flex items-center justify-center hover:bg-zinc-700"><Icon name="Plus" size={14}/></button>
                                    </div>
                                </div>
                                <div className="w-[1px] h-6 bg-zinc-800"></div>
                                <button onClick={() => { setForm(activeSong); setView('editor'); }} className="p-2 text-zinc-500 hover:text-indigo-400"><Icon name="Edit" size={18} /></button>
                                <button onClick={() => window.print()} className="p-2 text-zinc-500 hover:text-white"><Icon name="Printer" size={18} /></button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
