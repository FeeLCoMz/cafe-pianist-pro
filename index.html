<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe Pianist Pro - Ultra Edition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #09090b; color: #fafafa; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(18, 18, 21, 0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(39, 39, 42, 1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .chord-text { color: #818cf8; font-weight: 700; }
        .lyric-text { color: #a1a1aa; }
        .label-text { color: #fbbf24; font-weight: 800; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #3f3f46; margin-bottom: 4px; display: inline-block; width: 100%; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .metronome-pulse { animation: pulse-ring 2s infinite; }
        
        .btn-ghost { @apply p-2.5 rounded-xl transition-all duration-200; }
        .btn-ghost:hover { background-color: rgba(63, 63, 70, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.fb = { db, auth, appId, collection, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, writeBatch, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- UTILS ---
        const chromaticScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const flatsToSharps = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' };

        const transposeChord = (chordLine, semiTones) => {
            if (!chordLine || semiTones === 0) return chordLine;
            return chordLine.replace(/[A-G][#b]?(?:m|maj|min|dim|aug|sus|add)?[0-9]*(?:\/[A-G][#b]?)?/gi, (match) => {
                return match.replace(/[A-G][#b]?/g, (root) => {
                    let r = root.toUpperCase();
                    if (flatsToSharps[r]) r = flatsToSharps[r];
                    let index = chromaticScale.indexOf(r);
                    if (index === -1) return root;
                    let newIndex = (index + semiTones) % 12;
                    if (newIndex < 0) newIndex += 12;
                    return chromaticScale[newIndex];
                });
            });
        };

        const getYoutubeId = (url) => {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    window.lucide.createIcons({
                        icons: { [name]: window.lucide[name] },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={`inline-block align-middle ${className}`} ref={ref}></i>;
        };

        // --- MAIN APP ---

        function App() {
            const [user, setUser] = useState(null);
            const [songs, setSongs] = useState([]);
            const [setlists, setSetlists] = useState([]);
            
            const [activeTab, setActiveTab] = useState('library'); 
            const [searchTerm, setSearchTerm] = useState('');
            const [viewingSong, setViewingSong] = useState(null);
            const [activeSetlist, setActiveSetlist] = useState(null);
            
            const [isAdding, setIsAdding] = useState(false);
            const [isAddingSetlist, setIsAddingSetlist] = useState(false);
            const [status, setStatus] = useState(null);
            const [transpose, setTranspose] = useState(0);
            const [isMetronomeOn, setIsMetronomeOn] = useState(false);
            const [isAutoScrollOn, setIsAutoScrollOn] = useState(false);
            const [scrollSpeed, setScrollSpeed] = useState(20); 
            const [activeSubTab, setActiveSubTab] = useState('chords'); 

            const audioCtx = useRef(null);
            const scrollInterval = useRef(null);
            const scrollContainer = useRef(null);
            const fileInputRef = useRef(null);

            // 1. Initial Auth
            useEffect(() => {
                const initAuth = async () => {
                    const { auth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } = window.fb;
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    onAuthStateChanged(auth, setUser);
                };
                initAuth();
            }, []);

            // 2. Data Fetching (Cloud Sync)
            useEffect(() => {
                if (!user) return;
                const { db, appId, collection, query, onSnapshot } = window.fb;

                const songsRef = collection(db, 'artifacts', appId, 'public', 'data', 'songs');
                const setlistsRef = collection(db, 'artifacts', appId, 'public', 'data', 'setlists');

                const unsubSongs = onSnapshot(songsRef, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setSongs(data);
                }, (err) => console.error("Songs listener error:", err));

                const unsubSetlists = onSnapshot(setlistsRef, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setSetlists(data);
                }, (err) => console.error("Setlist listener error:", err));

                return () => { unsubSongs(); unsubSetlists(); };
            }, [user]);

            // Metronome Engine
            useEffect(() => {
                let timer;
                if (isMetronomeOn && viewingSong) {
                    if (!audioCtx.current) audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                    const bpm = parseInt(viewingSong.tempo) || 120;
                    timer = setInterval(() => {
                        const osc = audioCtx.current.createOscillator();
                        const env = audioCtx.current.createGain();
                        osc.frequency.setValueAtTime(1000, audioCtx.current.currentTime);
                        env.gain.exponentialRampToValueAtTime(0.001, audioCtx.current.currentTime + 0.05);
                        osc.connect(env); env.connect(audioCtx.current.destination);
                        osc.start(); osc.stop(audioCtx.current.currentTime + 0.05);
                    }, 60000/bpm);
                }
                return () => clearInterval(timer);
            }, [isMetronomeOn, viewingSong]);

            // Auto Scroll Engine
            useEffect(() => {
                if (isAutoScrollOn && scrollContainer.current) {
                    scrollInterval.current = setInterval(() => {
                        scrollContainer.current.scrollTop += 1;
                    }, 200 - (scrollSpeed * 5));
                } else {
                    clearInterval(scrollInterval.current);
                }
                return () => clearInterval(scrollInterval.current);
            }, [isAutoScrollOn, scrollSpeed]);

            const notify = (msg) => {
                setStatus(msg);
                setTimeout(() => setStatus(null), 3000);
            };

            const handleExport = () => {
                const data = JSON.stringify({ songs, setlists }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `C-Pianist-Backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                notify("Koleksi berhasil diekspor!");
            };

            const handleImport = async (event) => {
                const file = event.target.files[0];
                if (!file || !user) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.songs) {
                            const { db, appId, doc, writeBatch, collection } = window.fb;
                            const batch = writeBatch(db);
                            
                            importedData.songs.forEach(song => {
                                const songRef = doc(db, 'artifacts', appId, 'public', 'data', 'songs', song.id || Date.now().toString() + Math.random());
                                batch.set(songRef, song);
                            });

                            if (importedData.setlists) {
                                importedData.setlists.forEach(sl => {
                                    const slRef = doc(db, 'artifacts', appId, 'public', 'data', 'setlists', sl.id || Date.now().toString() + Math.random());
                                    batch.set(slRef, sl);
                                });
                            }

                            await batch.commit();
                            notify("Import Cloud Berhasil!");
                        }
                    } catch (err) {
                        notify("Gagal mengimport file.");
                    }
                };
                reader.readAsText(file);
                event.target.value = null;
            };

            const filteredSongs = useMemo(() => {
                return songs.filter(s => 
                    s.title?.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    s.artist?.toLowerCase().includes(searchTerm.toLowerCase())
                ).sort((a,b) => a.title.localeCompare(b.title));
            }, [songs, searchTerm]);

            const saveSong = async (songData) => {
                if (!user) return;
                const { db, appId, doc, setDoc } = window.fb;
                const id = songData.id || Date.now().toString();
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'songs', id), { ...songData, id });
                notify("Lagu tersimpan di Cloud");
            };

            const deleteSong = async (id) => {
                if(!user || !confirm("Hapus lagu ini dari Cloud?")) return;
                const { db, appId, doc, deleteDoc } = window.fb;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'songs', id));
                setViewingSong(null);
                notify("Lagu dihapus");
            };

            const saveSetlist = async (name, songIds) => {
                if (!user) return;
                const { db, appId, collection, addDoc } = window.fb;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'setlists'), {
                    name, songIds, createdAt: Date.now()
                });
                notify("Setlist tersimpan di Cloud");
            };

            const deleteSetlist = async (id) => {
                if(!user || !confirm("Hapus setlist ini?")) return;
                const { db, appId, doc, deleteDoc } = window.fb;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'setlists', id));
                notify("Setlist dihapus");
            };

            if (!user) return (
                <div className="h-screen bg-zinc-950 flex items-center justify-center">
                    <div className="flex flex-col items-center gap-4">
                        <div className="w-12 h-12 border-4 border-brand-600 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-zinc-500 font-bold uppercase tracking-widest text-xs">Menghubungkan ke Cloud...</p>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-screen overflow-hidden selection:bg-brand-500/30">
                    
                    {/* Status Message */}
                    {status && (
                        <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[300] bg-white text-zinc-950 px-6 py-3 rounded-full font-bold shadow-2xl flex items-center gap-2 animate-in slide-in-from-top-4">
                            <Icon name="Info" size={16} /> {status}
                        </div>
                    )}

                    {/* Navigation Bar */}
                    <nav className="glass sticky top-0 z-50 px-4 py-4 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="w-9 h-9 bg-brand-600 rounded-xl flex items-center justify-center text-white rotate-3 shadow-lg shadow-brand-600/20">
                                <Icon name="Piano" size={20} />
                            </div>
                            <span className="font-extrabold text-lg tracking-tighter uppercase italic hidden sm:inline-block">Cafe Pianist <span className="text-brand-500">PRO</span></span>
                        </div>
                        
                        <div className="flex items-center gap-1.5">
                            <input type="file" ref={fileInputRef} onChange={handleImport} accept=".json" className="hidden" />
                            <button title="Import (.json)" onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 px-3 py-2 text-emerald-400 hover:bg-emerald-400/10 rounded-xl transition-all font-bold text-xs uppercase">
                                <Icon name="UploadCloud" size={18} />
                                <span className="hidden md:inline">Import</span>
                            </button>

                            <button title="Export Koleksi" onClick={handleExport} className="flex items-center gap-2 px-3 py-2 text-zinc-300 hover:bg-white/10 rounded-xl transition-all font-bold text-xs uppercase">
                                <Icon name="DownloadCloud" size={18} />
                                <span className="hidden md:inline">Export</span>
                            </button>

                            <div className="h-6 w-px bg-zinc-800 mx-1" />

                            <button onClick={() => activeTab === 'library' ? setIsAdding(true) : setIsAddingSetlist(true)} className="flex items-center gap-2 pl-3 pr-4 py-2 bg-brand-600 text-white rounded-xl hover:bg-brand-500 shadow-lg shadow-brand-600/30 transition-all active:scale-95 font-bold text-xs uppercase">
                                <Icon name="Plus" size={18} />
                                <span>Tambah</span>
                            </button>
                        </div>
                    </nav>

                    {/* Content Area */}
                    <main className="flex-1 overflow-y-auto no-scrollbar p-4 md:p-8">
                        {/* Tab Switcher */}
                        <div className="max-w-4xl mx-auto flex p-1.5 bg-zinc-900 rounded-2xl border border-zinc-800 mb-8">
                            <button onClick={() => setActiveTab('library')} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-bold transition-all ${activeTab === 'library' ? 'bg-zinc-800 text-white shadow-sm' : 'text-zinc-500 hover:text-zinc-300'}`}>
                                <Icon name="Library" size={18}/> Koleksi
                            </button>
                            <button onClick={() => setActiveTab('setlists')} className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-bold transition-all ${activeTab === 'setlists' ? 'bg-zinc-800 text-white shadow-sm' : 'text-zinc-500 hover:text-zinc-300'}`}>
                                <Icon name="ListMusic" size={18}/> Setlist
                            </button>
                        </div>

                        {activeTab === 'library' ? (
                            <div className="max-w-4xl mx-auto space-y-6">
                                <div className="relative group">
                                    <Icon name="Search" className="absolute left-5 top-1/2 -translate-y-1/2 text-zinc-600 group-focus-within:text-brand-500 transition-colors" size={20}/>
                                    <input type="text" placeholder="Cari lagu atau artis..." className="w-full bg-zinc-900 border border-zinc-800 rounded-2xl py-4 pl-14 pr-6 outline-none focus:ring-4 focus:ring-brand-600/20 focus:border-brand-600/50 transition-all" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {filteredSongs.map(song => (
                                        <div key={song.id} onClick={() => { setViewingSong(song); setTranspose(0); setIsMetronomeOn(false); setActiveSubTab('chords'); }} className="group relative bg-zinc-900/50 border border-zinc-800/60 p-6 rounded-3xl hover:bg-zinc-900 hover:border-brand-500/40 transition-all cursor-pointer active:scale-[0.98]">
                                            <div className="flex justify-between items-start mb-1">
                                                <h3 className="font-bold text-lg leading-tight group-hover:text-brand-400 transition-colors">{song.title}</h3>
                                                {song.youtube && <Icon name="Youtube" size={16} className="text-red-500" />}
                                            </div>
                                            <p className="text-zinc-500 font-medium text-sm mb-5">{song.artist}</p>
                                            <div className="flex gap-4">
                                                <div className="flex items-center gap-1.5 px-3 py-1 bg-zinc-800 rounded-full text-[10px] font-black uppercase tracking-wider text-zinc-400">
                                                    <Icon name="Key" size={10} className="text-brand-500" /> {song.key}
                                                </div>
                                                <div className="flex items-center gap-1.5 px-3 py-1 bg-zinc-800 rounded-full text-[10px] font-black uppercase tracking-wider text-zinc-400">
                                                    <Icon name="Activity" size={10} className="text-emerald-500" /> {song.tempo} BPM
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {filteredSongs.length === 0 && (
                                        <div className="col-span-full py-20 flex flex-col items-center justify-center border-2 border-dashed border-zinc-900 rounded-3xl text-zinc-700">
                                            <Icon name="Music3" size={48} className="mb-4 opacity-20" />
                                            <p className="font-bold uppercase tracking-widest text-xs">Koleksi Cloud Kosong</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                                {setlists.map(sl => (
                                    <div key={sl.id} className="glass p-8 rounded-3xl flex flex-col border border-zinc-800">
                                        <div className="flex justify-between items-center mb-6">
                                            <div className="pr-4 min-w-0">
                                                <h3 className="text-xl font-black tracking-tighter uppercase truncate">{sl.name}</h3>
                                                <p className="text-xs font-bold text-brand-500 uppercase tracking-widest">{sl.songIds?.length || 0} Lagu</p>
                                            </div>
                                            <button onClick={() => deleteSetlist(sl.id)} className="p-2 text-zinc-700 hover:text-red-500 transition-colors">
                                                <Icon name="Trash2" size={20}/>
                                            </button>
                                        </div>
                                        <div className="space-y-3 mb-8 flex-1">
                                            {(sl.songIds || []).slice(0, 4).map(sid => {
                                                const song = songs.find(s => s.id === sid);
                                                return song ? (
                                                    <div key={sid} className="flex items-center gap-2 text-sm text-zinc-500 font-medium truncate">
                                                        <div className="w-1 h-1 bg-zinc-700 rounded-full" /> {song.title}
                                                    </div>
                                                ) : null;
                                            })}
                                        </div>
                                        <button onClick={() => setActiveSetlist(sl)} className="w-full py-4 bg-zinc-800 hover:bg-brand-600 text-white font-extrabold uppercase tracking-widest text-[10px] rounded-2xl transition-all shadow-xl active:scale-95">
                                            Buka Mode Gigs
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* SONG VIEWER MODAL */}
                    {viewingSong && (
                        <div className="fixed inset-0 z-[200] bg-zinc-950 flex flex-col animate-in slide-in-from-bottom-6 duration-300">
                            <header className="px-6 py-4 glass border-b border-zinc-900 flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <button onClick={() => { setViewingSong(null); setIsAutoScrollOn(false); setIsMetronomeOn(false); }} className="p-2.5 bg-zinc-900 rounded-xl">
                                        <Icon name="ArrowLeft" />
                                    </button>
                                    <div>
                                        <h2 className="font-black text-lg leading-none uppercase">{viewingSong.title}</h2>
                                        <p className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">{viewingSong.artist}</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => deleteSong(viewingSong.id)} className="p-2.5 text-zinc-600 hover:text-red-500 transition-colors"><Icon name="Trash2" /></button>
                                </div>
                            </header>

                            <div className="flex bg-zinc-950 border-b border-zinc-900">
                                {['chords', 'video', 'tools'].map(t => (
                                    <button key={t} onClick={() => setActiveSubTab(t)} className={`flex-1 py-4 text-[10px] font-black uppercase tracking-widest border-b-2 transition-all ${activeSubTab === t ? 'border-brand-500 text-brand-500 bg-brand-500/5' : 'border-transparent text-zinc-600'}`}>
                                        {t === 'chords' && <><Icon name="FileText" size={14} className="mb-1 block mx-auto" /> Chord</>}
                                        {t === 'video' && <><Icon name="Youtube" size={14} className="mb-1 block mx-auto" /> Video</>}
                                        {t === 'tools' && <><Icon name="Settings2" size={14} className="mb-1 block mx-auto" /> Setup</>}
                                    </button>
                                ))}
                            </div>

                            <div ref={scrollContainer} className="flex-1 overflow-y-auto no-scrollbar p-6 md:p-12">
                                <div className="max-w-4xl mx-auto">
                                    {activeSubTab === 'chords' && (
                                        <div className="bg-zinc-900/30 p-8 md:p-12 rounded-3xl border border-zinc-900 font-mono text-lg md:text-xl leading-relaxed whitespace-pre-wrap">
                                            {viewingSong.content.split('\n').map((line, i) => {
                                                const trimmed = line.trim();
                                                const isLabel = /^(Intro|Reff|Chorus|Verse|Bridge|Musik|Outro|Solo|Ending|Pre-Chorus)\s*[:|-]?/i.test(trimmed);
                                                const words = trimmed.split(/\s+/);
                                                const chordRegex = /^[A-G][#b]?(?:m|maj|min|dim|aug|sus|add)?[0-9]*(?:\/[A-G][#b]?)?$|^\|$/i;
                                                const isChordLine = !isLabel && words.filter(w => chordRegex.test(w) || w === '|').length / (words.length || 1) >= 0.5;

                                                if (isLabel) return <div key={i} className="label-text">{line}</div>;
                                                if (isChordLine) return <div key={i} className="chord-text">{transposeChord(line, transpose)}</div>;
                                                return <div key={i} className="lyric-text mb-4">{line}</div>;
                                            })}
                                        </div>
                                    )}

                                    {activeSubTab === 'video' && (
                                        <div className="flex flex-col items-center justify-center min-h-[50vh]">
                                            {viewingSong.youtube && getYoutubeId(viewingSong.youtube) ? (
                                                <div className="w-full aspect-video rounded-3xl overflow-hidden border border-zinc-800 shadow-2xl">
                                                    <iframe className="w-full h-full" src={`https://www.youtube.com/embed/${getYoutubeId(viewingSong.youtube)}`} allowFullScreen></iframe>
                                                </div>
                                            ) : (
                                                <div className="text-zinc-700 flex flex-col items-center">
                                                    <Icon name="VideoOff" size={64} className="mb-4 opacity-20"/>
                                                    <p className="font-bold uppercase tracking-widest text-xs">Video Tidak Tersedia</p>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {activeSubTab === 'tools' && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20">
                                            <div className="glass p-8 rounded-3xl border border-zinc-800">
                                                <h4 className="text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6">Transposisi Nada</h4>
                                                <div className="flex items-center justify-between">
                                                    <button onClick={() => setTranspose(v => v-1)} className="w-14 h-14 bg-zinc-800 rounded-2xl flex items-center justify-center active:scale-90 transition-all hover:bg-zinc-700"><Icon name="Minus"/></button>
                                                    <div className="text-center">
                                                        <div className="text-4xl font-black text-brand-400">{transpose > 0 ? `+${transpose}` : transpose}</div>
                                                        <div className="text-[10px] font-bold text-zinc-600 uppercase">Semidiatonic</div>
                                                    </div>
                                                    <button onClick={() => setTranspose(v => v+1)} className="w-14 h-14 bg-zinc-800 rounded-2xl flex items-center justify-center active:scale-90 transition-all hover:bg-zinc-700"><Icon name="Plus"/></button>
                                                </div>
                                            </div>

                                            <div className="glass p-8 rounded-3xl border border-zinc-800">
                                                <h4 className="text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6">Metronome (Visual)</h4>
                                                <button onClick={() => setIsMetronomeOn(!isMetronomeOn)} className={`w-full py-6 rounded-2xl flex flex-col items-center justify-center gap-2 transition-all ${isMetronomeOn ? 'bg-brand-600 text-white metronome-pulse shadow-lg shadow-brand-600/30' : 'bg-zinc-800 text-zinc-500'}`}>
                                                    <Icon name={isMetronomeOn ? "Volume2" : "VolumeX"} />
                                                    <span className="font-black uppercase tracking-tighter">{isMetronomeOn ? `AKTIF: ${viewingSong.tempo} BPM` : 'KETUKAN MATI'}</span>
                                                </button>
                                            </div>

                                            <div className="glass p-8 rounded-3xl md:col-span-2 border border-zinc-800">
                                                <h4 className="text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6">Auto-Scroll Control</h4>
                                                <div className="flex flex-col sm:flex-row items-center gap-6">
                                                    <button onClick={() => setIsAutoScrollOn(!isAutoScrollOn)} className={`w-20 h-20 rounded-2xl flex items-center justify-center transition-all flex-shrink-0 ${isAutoScrollOn ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-600/30' : 'bg-zinc-800 text-zinc-600'}`}>
                                                        <Icon name={isAutoScrollOn ? "Pause" : "Play"} size={32} />
                                                    </button>
                                                    <div className="flex-1 w-full">
                                                        <div className="flex justify-between text-[10px] font-black uppercase text-zinc-500 mb-4">
                                                            <span>Lambat</span>
                                                            <span className="text-brand-500">Kecepatan: {scrollSpeed}</span>
                                                            <span>Cepat</span>
                                                        </div>
                                                        <input type="range" min="1" max="40" className="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-brand-500" value={scrollSpeed} onChange={e => setScrollSpeed(parseInt(e.target.value))} />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="h-40" />
                            </div>
                        </div>
                    )}

                    {/* SETLIST GIGS MODE */}
                    {activeSetlist && (
                        <div className="fixed inset-0 z-[250] bg-black flex flex-col">
                            <header className="p-4 border-b border-zinc-900 flex justify-between items-center bg-zinc-950">
                                <h2 className="font-black uppercase italic tracking-tighter text-xl">Gig Mode: <span className="text-brand-500">{activeSetlist.name}</span></h2>
                                <button onClick={() => setActiveSetlist(null)} className="p-3 bg-zinc-900 rounded-full hover:bg-zinc-800 transition-colors"><Icon name="X" /></button>
                            </header>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
                                {(activeSetlist.songIds || []).map((sid, idx) => {
                                    const song = songs.find(s => s.id === sid);
                                    if(!song) return null;
                                    return (
                                        <div key={sid} onClick={() => { setViewingSong(song); setTranspose(0); setActiveSubTab('chords'); }} className="bg-zinc-900 p-6 rounded-3xl border border-zinc-800 flex items-center gap-5 active:bg-brand-600 transition-all group">
                                            <div className="w-12 h-12 bg-zinc-800 group-active:bg-brand-500 rounded-full flex items-center justify-center font-black text-xl text-zinc-500 group-active:text-white">{idx + 1}</div>
                                            <div className="flex-1 min-w-0 pr-2">
                                                <h4 className="font-black uppercase text-lg leading-none truncate">{song.title}</h4>
                                                <p className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">{song.artist}</p>
                                            </div>
                                            <Icon name="ChevronRight" className="text-zinc-800 group-active:text-white" />
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* ADD SONG MODAL */}
                    {isAdding && (
                        <div className="fixed inset-0 z-[400] bg-zinc-950/95 backdrop-blur-xl flex items-center justify-center p-4">
                            <div className="bg-zinc-900 border border-zinc-800 w-full max-w-2xl rounded-3xl p-8 md:p-10 shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar">
                                <div className="flex justify-between items-center mb-10">
                                    <h2 className="font-black uppercase tracking-widest text-brand-500 italic">Entri Lagu Baru</h2>
                                    <button onClick={() => setIsAdding(false)} className="p-3 bg-zinc-800 rounded-full text-zinc-500 hover:text-white transition-colors"><Icon name="X" /></button>
                                </div>
                                <form className="space-y-6" onSubmit={e => {
                                    e.preventDefault();
                                    const form = e.target;
                                    saveSong({
                                        title: form.title.value,
                                        artist: form.artist.value,
                                        key: form.key.value,
                                        tempo: form.tempo.value,
                                        youtube: form.youtube.value,
                                        content: form.content.value
                                    });
                                    setIsAdding(false);
                                }}>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="space-y-1.5">
                                            <label className="text-[10px] font-black uppercase ml-4 text-zinc-600">Judul Lagu</label>
                                            <input name="title" required placeholder="Contoh: Bohemian Rhapsody" className="w-full bg-zinc-800/50 p-4 rounded-xl outline-none focus:ring-2 ring-brand-500 transition-all" />
                                        </div>
                                        <div className="space-y-1.5">
                                            <label className="text-[10px] font-black uppercase ml-4 text-zinc-600">Nama Artis</label>
                                            <input name="artist" required placeholder="Contoh: Queen" className="w-full bg-zinc-800/50 p-4 rounded-xl outline-none focus:ring-2 ring-brand-500 transition-all" />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div className="space-y-1.5">
                                            <label className="text-[10px] font-black uppercase ml-4 text-zinc-600">Nada Dasar</label>
                                            <input name="key" required placeholder="C" className="w-full bg-zinc-800/50 p-4 rounded-xl outline-none text-center font-bold" />
                                        </div>
                                        <div className="space-y-1.5">
                                            <label className="text-[10px] font-black uppercase ml-4 text-zinc-600">BPM</label>
                                            <input name="tempo" type="number" required placeholder="120" className="w-full bg-zinc-800/50 p-4 rounded-xl outline-none text-center font-bold" />
                                        </div>
                                        <div className="space-y-1.5">
                                            <label className="text-[10px] font-black uppercase ml-4 text-zinc-600">YouTube URL</label>
                                            <input name="youtube" placeholder="https://..." className="w-full bg-zinc-800/50 p-4 rounded-xl outline-none" />
                                        </div>
                                    </div>
                                    <div className="space-y-1.5">
                                        <label className="text-[10px] font-black uppercase ml-4 text-zinc-600">Isi Chords & Lirik</label>
                                        <textarea name="content" required rows="8" placeholder="Tuliskan chord dan lirik di sini..." className="w-full bg-zinc-800/50 p-6 rounded-2xl font-mono text-sm outline-none resize-none focus:ring-2 ring-brand-500 transition-all"></textarea>
                                    </div>
                                    <button type="submit" className="w-full py-5 bg-brand-600 rounded-2xl font-black uppercase tracking-widest text-sm shadow-xl shadow-brand-600/20 active:scale-95 transition-all">Simpan ke Cloud</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* ADD SETLIST MODAL */}
                    {isAddingSetlist && (
                        <div className="fixed inset-0 z-[400] bg-zinc-950/95 backdrop-blur-xl flex items-center justify-center p-4">
                            <div className="bg-zinc-900 border border-zinc-800 w-full max-w-xl rounded-3xl p-10 flex flex-col max-h-[85vh]">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="font-black uppercase tracking-widest text-brand-500">Buat Setlist Baru</h2>
                                    <button onClick={() => setIsAddingSetlist(false)} className="p-3 bg-zinc-800 rounded-full text-zinc-500 hover:text-white transition-colors"><Icon name="X" /></button>
                                </div>
                                <input id="sl-name" placeholder="Nama Setlist (Contoh: Wedding 24 Des)" className="w-full bg-zinc-900 p-5 rounded-xl outline-none mb-6 font-bold focus:ring-2 ring-brand-500 border border-zinc-800" />
                                <div className="flex-1 overflow-y-auto space-y-2 mb-8 no-scrollbar pr-2">
                                    {songs.map(song => (
                                        <label key={song.id} className="flex items-center justify-between p-4 rounded-2xl bg-zinc-800/40 border border-transparent has-[:checked]:border-brand-500 has-[:checked]:bg-brand-500/5 transition-all cursor-pointer hover:bg-zinc-800/60">
                                            <div className="flex-1 min-w-0 pr-4">
                                                <p className="font-bold truncate">{song.title}</p>
                                                <p className="text-[10px] text-zinc-500 font-bold uppercase">{song.artist}</p>
                                            </div>
                                            <input type="checkbox" className="w-6 h-6 rounded-lg accent-brand-500 cursor-pointer" value={song.id} />
                                        </label>
                                    ))}
                                </div>
                                <button onClick={() => {
                                    const name = document.getElementById('sl-name').value;
                                    const selected = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                                    if(name && selected.length > 0) {
                                        saveSetlist(name, selected);
                                        setIsAddingSetlist(false);
                                    }
                                }} className="w-full py-5 bg-brand-600 rounded-2xl font-black uppercase tracking-widest text-sm active:scale-95 transition-all">Selesaikan Setlist</button>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
